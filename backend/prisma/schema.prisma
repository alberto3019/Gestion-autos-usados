// This is your Prisma schema file

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum AgencyStatus {
  pending
  active
  blocked
}

enum UserRole {
  super_admin
  agency_admin
  agency_user
}

enum VehicleCondition {
  new
  used
}

enum VehicleStatus {
  available
  reserved
  sold
  paused
}

enum FuelType {
  gasoline
  diesel
  hybrid
  electric
  other
}

enum Transmission {
  manual
  automatic
  cvt
  other
}

enum Currency {
  ARS
  USD
  EUR
}

enum ActivityType {
  agency_registered
  agency_approved
  agency_blocked
  agency_updated
  user_created
  user_updated
  user_deleted
  user_login
  user_logout
  vehicle_created
  vehicle_updated
  vehicle_deleted
  vehicle_status_changed
  favorite_added
  favorite_removed
  whatsapp_contact
  search_performed
}

// Models
model Agency {
  id             String        @id @default(uuid())
  businessName   String        @map("business_name")
  commercialName String        @map("commercial_name")
  taxId          String        @unique @map("tax_id")
  addressStreet  String?       @map("address_street")
  addressCity    String?       @map("address_city")
  addressState   String?       @map("address_state")
  addressCountry String        @default("Argentina") @map("address_country")
  phone          String?
  whatsapp       String
  email          String        @unique
  instagramUrl   String?       @map("instagram_url")
  facebookUrl    String?       @map("facebook_url")
  websiteUrl     String?       @map("website_url")
  logoUrl        String?       @map("logo_url")
  status         AgencyStatus  @default(pending)
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  // Relations
  users    User[]
  vehicles Vehicle[]

  @@index([status])
  @@index([email])
  @@map("agencies")
}

model User {
  id           String   @id @default(uuid())
  agencyId     String?  @map("agency_id")
  email        String   @unique
  passwordHash String   @map("password_hash")
  firstName    String   @map("first_name")
  lastName     String   @map("last_name")
  role         UserRole @default(agency_user)
  isActive           Boolean  @default(true) @map("is_active")
  refreshToken       String?  @map("refresh_token") @db.Text
  passwordResetToken String?  @map("password_reset_token") @db.Text
  passwordResetExpires DateTime? @map("password_reset_expires")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  // Relations
  agency            Agency?            @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  favorites         Favorite[]
  whatsappClickLogs WhatsappClickLog[]
  notifications     Notification[]

  @@index([email])
  @@index([agencyId])
  @@map("users")
}

model Vehicle {
  id               String           @id @default(uuid())
  agencyId         String           @map("agency_id")
  brand            String
  model            String
  version          String?
  year             Int
  kilometers       Int
  fuelType         FuelType         @map("fuel_type")
  transmission     Transmission
  color            String?
  licensePlate     String?          @map("license_plate")
  hideLicensePlate Boolean          @default(false) @map("hide_license_plate")
  price            Decimal          @db.Decimal(15, 2)
  currency         Currency         @default(ARS)
  condition        VehicleCondition @default(used)
  status           VehicleStatus    @default(available)
  locationCity     String?          @map("location_city")
  locationState    String?          @map("location_state")
  internalNotes    String?          @map("internal_notes") @db.Text
  publicNotes      String?          @map("public_notes") @db.Text
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")

  // Relations
  agency            Agency             @relation(fields: [agencyId], references: [id], onDelete: Cascade)
  photos            VehiclePhoto[]
  favorites         Favorite[]
  whatsappClickLogs WhatsappClickLog[]

  @@index([agencyId])
  @@index([brand, model])
  @@index([status])
  @@index([year])
  @@index([price])
  @@index([createdAt(sort: Desc)])
  @@map("vehicles")
}

model VehiclePhoto {
  id        String   @id @default(uuid())
  vehicleId String   @map("vehicle_id")
  url       String
  order     Int      @default(0)
  isPrimary Boolean  @default(false) @map("is_primary")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@map("vehicle_photos")
}

model Favorite {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  vehicleId String   @map("vehicle_id")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@unique([userId, vehicleId])
  @@index([userId])
  @@map("favorites")
}

model WhatsappClickLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  vehicleId String   @map("vehicle_id")
  clickedAt DateTime @default(now()) @map("clicked_at")

  // Relations
  user    User?   @relation(fields: [userId], references: [id], onDelete: SetNull)
  vehicle Vehicle @relation(fields: [vehicleId], references: [id], onDelete: Cascade)

  @@index([vehicleId])
  @@index([userId])
  @@index([clickedAt(sort: Desc)])
  @@map("whatsapp_click_logs")
}

model ActivityLog {
  id          String       @id @default(uuid())
  userId      String?      @map("user_id")
  agencyId    String?      @map("agency_id")
  type        ActivityType
  action      String
  description String
  metadata    Json?
  ipAddress   String?      @map("ip_address")
  userAgent   String?      @map("user_agent")
  createdAt   DateTime     @default(now()) @map("created_at")

  @@index([userId])
  @@index([agencyId])
  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@map("activity_logs")
}

model Notification {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  type      String   // 'search_alert', 'system', etc.
  title     String
  message   String   @db.Text
  data      Json?    // Datos adicionales (vehicleIds, alertId, etc.)
  isRead    Boolean  @default(false) @map("is_read")
  readAt    DateTime? @map("read_at")
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt(sort: Desc)])
  @@map("notifications")
}

